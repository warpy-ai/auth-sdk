import { DocsLayout } from '@/components/docs/docs-layout';
import { CodeBlock } from '@/components/docs/code-block';
import { Callout } from '@/components/docs/callout';

export const metadata = {
  title: 'Express Adapter - @warpy-auth-sdk/core',
  description: 'Using @warpy-auth-sdk/core with Express',
};

export default function ExpressAdapter() {
  return (
    <DocsLayout
      title="Express Adapter"
      description="Using @warpy-auth-sdk/core with Express"
      nextPage={{ title: 'Hono Adapter', href: '/docs/guides/hono-adapter' }}
    >
      <div>
        <h2>Express Adapter</h2>

        <p>
          The Express adapter provides seamless integration of <code>@warpy-auth-sdk/core</code> with Express applications. It handles all authentication routes and provides middleware for protecting your API endpoints.
        </p>

        <h2>Installation</h2>

        <CodeBlock language="bash">{`npm install @warpy-auth-sdk/core express cookie-parser
# or
yarn add @warpy-auth-sdk/core express cookie-parser
# or
pnpm add @warpy-auth-sdk/core express cookie-parser`}</CodeBlock>

        <h2>Quick Start</h2>

        <h3>1. Basic Setup</h3>

        <CodeBlock language="typescript">{`import express from "express";
import cookieParser from "cookie-parser";
import { registerAuthRoutes } from "@warpy-auth-sdk/core/adapters/express";
import { google } from "@warpy-auth-sdk/core";

const app = express();

// Required middleware
app.use(express.json());
app.use(cookieParser());

// Configure authentication
const { requireAuth } = registerAuthRoutes(app, {
  secret: process.env.AUTH_SECRET!,
  provider: google({
    clientId: process.env.GOOGLE_CLIENT_ID!,
    clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    redirectUri: "http://localhost:3000/api/auth/callback/google",
  }),
}, {
  basePath: "/api/auth",
  successRedirect: "/dashboard",
  errorRedirect: "/login",
});

// Protected route
app.get("/api/user", requireAuth, (req, res) => {
  res.json({ user: req.session.user });
});

app.listen(3000, () => {
  console.log("Server running on http://localhost:3000");
});`}</CodeBlock>

        <h3>2. Environment Variables</h3>

        <p>Create a <code>.env</code> file:</p>

        <CodeBlock language="bash">{`AUTH_SECRET=your-secret-key-min-32-chars
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
GOOGLE_REDIRECT_URI=http://localhost:3000/api/auth/callback/google`}</CodeBlock>

        <h2>API Reference</h2>

        <h3>registerAuthRoutes(app, config, options)</h3>

        <p>Registers authentication routes on your Express application.</p>

        <h4>Parameters</h4>

        <ul>
          <li><strong>app</strong> (<code>express.Application</code>): Your Express app instance</li>
          <li><strong>config</strong> (<code>AuthConfig</code>): Authentication configuration
            <ul>
              <li><code>secret</code>: JWT signing secret (min 32 characters)</li>
              <li><code>provider</code>: OAuth provider (Google, GitHub, etc.)</li>
              <li><code>adapter</code>: Optional database adapter for session persistence</li>
              <li><code>callbacks</code>: Optional callbacks for customization</li>
            </ul>
          </li>
          <li><strong>options</strong> (<code>ExpressAuthOptions</code>): Optional configuration
            <ul>
              <li><code>basePath</code>: Base path for auth routes (default: <code>/auth</code>)</li>
              <li><code>successRedirect</code>: Redirect after successful auth (default: <code>/</code>)</li>
              <li><code>errorRedirect</code>: Redirect after auth failure (default: <code>/login</code>)</li>
              <li><code>mcp</code>: MCP (AI agent) configuration</li>
            </ul>
          </li>
        </ul>

        <h4>Returns</h4>

        <p>An object with:</p>
        <ul>
          <li><code>requireAuth</code>: Middleware function to protect routes</li>
        </ul>

        <h3>Registered Routes</h3>

        <p>When you call <code>registerAuthRoutes()</code>, the following routes are automatically registered:</p>

        <ul>
          <li><code>GET {`{basePath}`}/session</code> - Get current session</li>
          <li><code>POST {`{basePath}`}/signout</code> - Sign out user</li>
          <li><code>GET {`{basePath}`}/signin</code> - Generic sign-in</li>
          <li><code>GET {`{basePath}`}/signin/:provider</code> - Provider-specific sign-in (e.g., <code>/signin/google</code>)</li>
          <li><code>GET {`{basePath}`}/callback</code> - Generic OAuth callback</li>
          <li><code>GET {`{basePath}`}/callback/:provider</code> - Provider-specific callback</li>
        </ul>

        <h2>Usage Examples</h2>

        <h3>Protecting Routes</h3>

        <CodeBlock language="typescript">{`// Single protected route
app.get("/api/user", requireAuth, (req, res) => {
  res.json({ user: req.session.user });
});

// Multiple middleware
app.get("/api/admin",
  requireAuth,
  checkAdminRole,
  (req, res) => {
    res.json({ message: "Admin only" });
  }
);

// Protect a group of routes
app.use("/api/protected", requireAuth);
app.get("/api/protected/data", (req, res) => {
  res.json({ data: "Secret data" });
});`}</CodeBlock>

        <h3>Multiple Providers</h3>

        <CodeBlock language="typescript">{`import { google, github, facebook } from "@warpy-auth-sdk/core";

// Register auth for multiple providers
const providers = [
  google({ clientId: "...", clientSecret: "...", redirectUri: "..." }),
  github({ clientId: "...", clientSecret: "...", redirectUri: "..." }),
  facebook({ clientId: "...", clientSecret: "...", redirectUri: "..." }),
];

// You'll need to register routes for each provider separately
// or use a dynamic provider selection approach`}</CodeBlock>

        <h3>Custom Callbacks</h3>

        <CodeBlock language="typescript">{`registerAuthRoutes(app, {
  secret: process.env.AUTH_SECRET!,
  provider: google({ /* config */ }),
  callbacks: {
    // Resolve/create user in your database
    async user(oauthUser) {
      const user = await db.user.findOrCreate({
        where: { email: oauthUser.email },
        defaults: {
          name: oauthUser.name,
          picture: oauthUser.picture,
        },
      });
      return user;
    },
    // Customize JWT claims
    jwt(token) {
      token.customClaim = "value";
      return token;
    },
    // Customize session object
    session(session) {
      session.customData = "value";
      return session;
    },
  },
});`}</CodeBlock>

        <h3>With Database Adapter</h3>

        <CodeBlock language="typescript">{`import { PrismaAdapter } from "@warpy-auth-sdk/core";
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

registerAuthRoutes(app, {
  secret: process.env.AUTH_SECRET!,
  provider: google({ /* config */ }),
  adapter: PrismaAdapter(prisma),
});`}</CodeBlock>

        <h3>MCP (AI Agent) Support</h3>

        <CodeBlock language="typescript">{`registerAuthRoutes(app, {
  secret: process.env.AUTH_SECRET!,
  provider: google({ /* config */ }),
}, {
  basePath: "/api/auth",
  mcp: {
    enabled: true,
    path: "/api/mcp",
    shield: {
      secret: process.env.AUTH_SECRET!,
      warpy: {
        apiKey: process.env.WARPY_API_KEY,
      },
    },
  },
});

// Now AI agents can call POST /api/mcp with tool requests`}</CodeBlock>

        <h2>TypeScript Support</h2>

        <p>The adapter includes full TypeScript support with type definitions:</p>

        <CodeBlock language="typescript">{`import type {
  ExpressApplication,
  ExpressRequest,
  ExpressResponse,
  ExpressAuthOptions,
  RequireAuth,
} from "@warpy-auth-sdk/core/adapters/express";

// Access session in protected routes
app.get("/api/user", requireAuth, (req: ExpressRequest, res: ExpressResponse) => {
  const session = req.session; // Fully typed
  res.json({ user: session.user });
});`}</CodeBlock>

        <h2>Complete Example</h2>

        <p>
          See the <a href="https://github.com/warpy-ai/auth-sdk/tree/main/examples/express-example" target="_blank">complete Express example</a> in the repository for a full working application.
        </p>

        <h2>Comparison with Other Adapters</h2>

        <table>
          <thead>
            <tr>
              <th>Feature</th>
              <th>Express</th>
              <th>Fastify</th>
              <th>Hono</th>
              <th>Node.js</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Framework Dependency</td>
              <td>Yes</td>
              <td>Yes</td>
              <td>Yes</td>
              <td>No</td>
            </tr>
            <tr>
              <td>Middleware Pattern</td>
              <td>Yes</td>
              <td>preHandler</td>
              <td>Yes</td>
              <td>Manual</td>
            </tr>
            <tr>
              <td>TypeScript Support</td>
              <td>✓</td>
              <td>✓</td>
              <td>✓</td>
              <td>✓</td>
            </tr>
            <tr>
              <td>MCP Support</td>
              <td>✓</td>
              <td>✓</td>
              <td>✓</td>
              <td>✓</td>
            </tr>
            <tr>
              <td>Multi-runtime</td>
              <td>Node only</td>
              <td>Node only</td>
              <td>Node/Deno/Bun/CF</td>
              <td>Node only</td>
            </tr>
          </tbody>
        </table>

        <h2>Troubleshooting</h2>

        <h3>Session not persisting</h3>

        <p>Make sure you've registered the <code>cookie-parser</code> middleware:</p>

        <CodeBlock language="typescript">{`import cookieParser from "cookie-parser";
app.use(cookieParser());`}</CodeBlock>

        <h3>401 Unauthorized on protected routes</h3>

        <p>Ensure the user is authenticated before accessing protected routes:</p>

        <CodeBlock language="typescript">{`// Check if user is authenticated
app.get("/api/auth/session", async (req, res) => {
  const session = await getSession(req, config.secret);
  res.json({ session });
});`}</CodeBlock>

        <h3>CORS issues</h3>

        <p>If your frontend is on a different domain, configure CORS:</p>

        <CodeBlock language="typescript">{`import cors from "cors";

app.use(cors({
  origin: "http://localhost:5173",
  credentials: true,
}));`}</CodeBlock>

        <h2>Next Steps</h2>

        <ul>
          <li><a href="/docs/guides/two-factor-authentication">Two-Factor Authentication</a></li>
          <li><a href="/docs/adapters">Database Adapters</a></li>
          <li><a href="/docs/mcp">MCP Integration</a></li>
          <li><a href="/docs/api-reference">API Reference</a></li>
        </ul>
      </div>
    </DocsLayout>
  );
}

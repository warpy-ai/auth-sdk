import { DocsLayout } from '@/components/docs/docs-layout';
import { CodeBlock } from '@/components/docs/code-block';
import { Callout } from '@/components/docs/callout';

export const metadata = {
  title: 'Node.js HTTP Adapter - @warpy-auth-sdk/core',
  description: 'Using @warpy-auth-sdk/core with pure Node.js HTTP',
};

export default function NodejsAdapter() {
  return (
    <DocsLayout
      title="Node.js HTTP Adapter"
      description="Using @warpy-auth-sdk/core with pure Node.js HTTP"
      prevPage={{ title: 'Hono Adapter', href: '/docs/guides/hono-adapter' }}
      nextPage={{ title: 'Two-Factor Authentication', href: '/docs/guides/two-factor-authentication' }}
    >
      <div>
        <h2>Node.js HTTP Adapter</h2>

        <p>
          The Node.js HTTP adapter provides integration of <code>@warpy-auth-sdk/core</code> with the native Node.js <code>http</code> module. This adapter has zero framework dependencies and gives you maximum control and flexibility.
        </p>

        <h2>Installation</h2>

        <CodeBlock language="bash">{`npm install @warpy-auth-sdk/core
# or
yarn add @warpy-auth-sdk/core
# or
pnpm add @warpy-auth-sdk/core`}</CodeBlock>

        <p>No additional dependencies required!</p>

        <h2>Quick Start</h2>

        <h3>Basic Setup</h3>

        <CodeBlock language="typescript">{`import { createServer } from "http";
import { createAuthHandler } from "@warpy-auth-sdk/core/adapters/node";
import { google } from "@warpy-auth-sdk/core";

// Configure authentication
const { handler, requireAuth } = createAuthHandler({
  secret: process.env.AUTH_SECRET!,
  provider: google({
    clientId: process.env.GOOGLE_CLIENT_ID!,
    clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    redirectUri: "http://localhost:3000/api/auth/callback/google",
  }),
}, {
  basePath: "/api/auth",
  successRedirect: "/dashboard",
  errorRedirect: "/login",
});

// Create HTTP server
const server = createServer(async (req, res) => {
  // Try auth handler first
  const handled = await handler(req, res);
  if (handled) return;

  // Your custom routes
  if (req.url === "/api/user" && req.method === "GET") {
    const authenticated = await requireAuth(req, res);
    if (!authenticated) return; // Already sent 401

    res.writeHead(200, { "content-type": "application/json" });
    res.end(JSON.stringify({ user: req.session.user }));
    return;
  }

  // 404
  res.writeHead(404);
  res.end("Not Found");
});

server.listen(3000, () => {
  console.log("Server running on http://localhost:3000");
});`}</CodeBlock>

        <h2>API Reference</h2>

        <h3>createAuthHandler(config, options)</h3>

        <p>Creates an authentication handler and middleware for Node.js HTTP servers.</p>

        <h4>Parameters</h4>

        <ul>
          <li><strong>config</strong> (<code>AuthConfig</code>): Authentication configuration
            <ul>
              <li><code>secret</code>: JWT signing secret (min 32 characters)</li>
              <li><code>provider</code>: OAuth provider (Google, GitHub, etc.)</li>
              <li><code>adapter</code>: Optional database adapter</li>
              <li><code>callbacks</code>: Optional callbacks</li>
            </ul>
          </li>
          <li><strong>options</strong> (<code>NodeAuthOptions</code>): Optional configuration
            <ul>
              <li><code>basePath</code>: Base path for auth routes (default: <code>/auth</code>)</li>
              <li><code>successRedirect</code>: Redirect after successful auth (default: <code>/</code>)</li>
              <li><code>errorRedirect</code>: Redirect after auth failure (default: <code>/login</code>)</li>
              <li><code>mcp</code>: MCP configuration</li>
            </ul>
          </li>
        </ul>

        <h4>Returns</h4>

        <p>An object with:</p>
        <ul>
          <li><code>handler</code>: Async function to handle auth routes</li>
          <li><code>requireAuth</code>: Middleware function to protect routes</li>
        </ul>

        <h3>Handler Routes</h3>

        <p>When a request matches these routes, the handler returns <code>true</code>:</p>

        <ul>
          <li><code>GET {`{basePath}`}/session</code> - Get current session</li>
          <li><code>POST {`{basePath}`}/signout</code> - Sign out user</li>
          <li><code>GET {`{basePath}`}/signin/:provider</code> - Provider-specific sign-in</li>
          <li><code>GET {`{basePath}`}/callback/:provider</code> - Provider-specific callback</li>
          <li><code>POST {`{basePath}`}/mcp</code> - MCP tools endpoint (if enabled)</li>
        </ul>

        <h2>Usage Examples</h2>

        <h3>Protecting Routes</h3>

        <CodeBlock language="typescript">{`const server = createServer(async (req, res) => {
  const handled = await handler(req, res);
  if (handled) return;

  // Protected API endpoint
  if (req.url === "/api/user" && req.method === "GET") {
    const authenticated = await requireAuth(req, res);
    if (!authenticated) return; // requireAuth sends 401 response

    // Access session from req.session
    res.writeHead(200, { "content-type": "application/json" });
    res.end(JSON.stringify({ user: req.session.user }));
    return;
  }

  // Public endpoint
  if (req.url === "/api/health") {
    res.writeHead(200, { "content-type": "application/json" });
    res.end(JSON.stringify({ status: "ok" }));
    return;
  }

  res.writeHead(404);
  res.end("Not Found");
});`}</CodeBlock>

        <h3>Serving Static Files</h3>

        <CodeBlock language="typescript">{`import { readFileSync } from "fs";
import { join } from "path";

const server = createServer(async (req, res) => {
  const handled = await handler(req, res);
  if (handled) return;

  const url = new URL(req.url!, \`http://\${req.headers.host}\`);

  // Serve HTML
  if (url.pathname === "/") {
    const html = readFileSync(join(__dirname, "public/index.html"));
    res.writeHead(200, { "content-type": "text/html" });
    res.end(html);
    return;
  }

  // Serve static assets
  if (url.pathname.startsWith("/public/")) {
    try {
      const file = readFileSync(join(__dirname, url.pathname));
      res.writeHead(200);
      res.end(file);
      return;
    } catch {
      res.writeHead(404);
      res.end("Not Found");
    }
  }
});`}</CodeBlock>

        <h3>Custom Callbacks</h3>

        <CodeBlock language="typescript">{`const { handler, requireAuth } = createAuthHandler({
  secret: process.env.AUTH_SECRET!,
  provider: google({ /* config */ }),
  callbacks: {
    async user(oauthUser) {
      // Create or update user in your database
      return await db.user.findOrCreate({
        where: { email: oauthUser.email },
        defaults: {
          name: oauthUser.name,
          picture: oauthUser.picture,
        },
      });
    },
    jwt(token) {
      token.role = "user";
      return token;
    },
    session(session) {
      session.customField = "value";
      return session;
    },
  },
});`}</CodeBlock>

        <h3>With Database Adapter</h3>

        <CodeBlock language="typescript">{`import { PrismaAdapter } from "@warpy-auth-sdk/core";
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

const { handler, requireAuth } = createAuthHandler({
  secret: process.env.AUTH_SECRET!,
  provider: google({ /* config */ }),
  adapter: PrismaAdapter(prisma),
});`}</CodeBlock>

        <h3>MCP (AI Agent) Support</h3>

        <CodeBlock language="typescript">{`const { handler, requireAuth } = createAuthHandler({
  secret: process.env.AUTH_SECRET!,
  provider: google({ /* config */ }),
}, {
  basePath: "/api/auth",
  mcp: {
    enabled: true,
    path: "/api/mcp",
    shield: {
      secret: process.env.AUTH_SECRET!,
      warpy: {
        apiKey: process.env.WARPY_API_KEY,
      },
    },
  },
});

// MCP tools now available at POST /api/mcp`}</CodeBlock>

        <h3>URL Routing</h3>

        <CodeBlock language="typescript">{`import { parse } from "url";

const server = createServer(async (req, res) => {
  const handled = await handler(req, res);
  if (handled) return;

  const { pathname } = parse(req.url || "/", true);

  // Route matching
  switch (pathname) {
    case "/":
      // Home page
      break;
    case "/api/user":
      const authenticated = await requireAuth(req, res);
      if (!authenticated) return;
      // Handle user API
      break;
    default:
      res.writeHead(404);
      res.end("Not Found");
  }
});`}</CodeBlock>

        <h3>Request Body Parsing</h3>

        <CodeBlock language="typescript">{`async function parseJSON(req: IncomingMessage): Promise<any> {
  return new Promise((resolve, reject) => {
    let body = "";
    req.on("data", (chunk) => {
      body += chunk.toString();
    });
    req.on("end", () => {
      try {
        resolve(JSON.parse(body));
      } catch (err) {
        reject(err);
      }
    });
  });
}

const server = createServer(async (req, res) => {
  const handled = await handler(req, res);
  if (handled) return;

  if (req.url === "/api/data" && req.method === "POST") {
    try {
      const body = await parseJSON(req);
      res.writeHead(200, { "content-type": "application/json" });
      res.end(JSON.stringify({ received: body }));
    } catch {
      res.writeHead(400);
      res.end("Invalid JSON");
    }
  }
});`}</CodeBlock>

        <h2>TypeScript Support</h2>

        <p>The adapter includes full TypeScript support:</p>

        <CodeBlock language="typescript">{`import type {
  IncomingMessage,
  ServerResponse,
  NodeAuthOptions,
  NodeAuthMiddleware,
  Session,
} from "@warpy-auth-sdk/core/adapters/node";

// Extend request type with session
declare module "http" {
  interface IncomingMessage {
    session?: Session;
  }
}

// Typed handler
const server = createServer(
  async (req: IncomingMessage, res: ServerResponse) => {
    // ...
  }
);`}</CodeBlock>

        <h2>Complete Example</h2>

        <p>
          See the <a href="https://github.com/warpy-ai/auth-sdk/tree/main/examples/node-example" target="_blank">complete Node.js example</a> in the repository.
        </p>

        <h2>Comparison with Other Adapters</h2>

        <table>
          <thead>
            <tr>
              <th>Feature</th>
              <th>Node.js</th>
              <th>Express</th>
              <th>Fastify</th>
              <th>Hono</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Framework Dependency</td>
              <td>None</td>
              <td>Yes</td>
              <td>Yes</td>
              <td>Yes</td>
            </tr>
            <tr>
              <td>Bundle Size</td>
              <td>Smallest</td>
              <td>Medium</td>
              <td>Medium</td>
              <td>Small</td>
            </tr>
            <tr>
              <td>Learning Curve</td>
              <td>Steep</td>
              <td>Easy</td>
              <td>Easy</td>
              <td>Easy</td>
            </tr>
            <tr>
              <td>Flexibility</td>
              <td>Maximum</td>
              <td>High</td>
              <td>High</td>
              <td>High</td>
            </tr>
            <tr>
              <td>TypeScript Support</td>
              <td>✓</td>
              <td>✓</td>
              <td>✓</td>
              <td>✓</td>
            </tr>
            <tr>
              <td>MCP Support</td>
              <td>✓</td>
              <td>✓</td>
              <td>✓</td>
              <td>✓</td>
            </tr>
            <tr>
              <td>Best For</td>
              <td>Microservices, Serverless</td>
              <td>Traditional apps</td>
              <td>High performance</td>
              <td>Multi-runtime</td>
            </tr>
          </tbody>
        </table>

        <h2>Benefits of Pure Node.js</h2>

        <ol>
          <li><strong>Zero Dependencies</strong>: No framework overhead</li>
          <li><strong>Maximum Control</strong>: Full control over request/response handling</li>
          <li><strong>Smallest Bundle</strong>: Minimal production footprint</li>
          <li><strong>Learning</strong>: Understand HTTP fundamentals</li>
          <li><strong>Flexibility</strong>: Easy to integrate with any HTTP server</li>
        </ol>

        <h2>When to Use</h2>

        <p>Choose the Node.js adapter when:</p>

        <ul>
          <li>Building microservices with minimal dependencies</li>
          <li>Deploying to serverless/edge environments</li>
          <li>Need maximum performance</li>
          <li>Want full control over HTTP handling</li>
          <li>Learning HTTP fundamentals</li>
        </ul>

        <p>Choose a framework adapter when:</p>

        <ul>
          <li>Building traditional web applications</li>
          <li>Need rich middleware ecosystem</li>
          <li>Want faster development</li>
          <li>Team is familiar with the framework</li>
        </ul>

        <h2>Troubleshooting</h2>

        <h3>Session not persisting</h3>

        <p>The adapter automatically handles cookies. Ensure your client sends cookies:</p>

        <CodeBlock language="typescript">{`fetch("/api/user", {
  credentials: "include", // Important!
});`}</CodeBlock>

        <h3>Handler not catching routes</h3>

        <p>Make sure you call the handler before your custom routes:</p>

        <CodeBlock language="typescript">{`const server = createServer(async (req, res) => {
  // Call handler FIRST
  const handled = await handler(req, res);
  if (handled) return;

  // Then your routes
  // ...
});`}</CodeBlock>

        <h3>Request body issues</h3>

        <p>The adapter handles body parsing for MCP endpoints. For custom endpoints, parse manually:</p>

        <CodeBlock language="typescript">{`async function readBody(req): Promise<string> {
  return new Promise((resolve) => {
    let body = "";
    req.on("data", (chunk) => body += chunk);
    req.on("end", () => resolve(body));
  });
}`}</CodeBlock>

        <h3>CORS issues</h3>

        <p>Add CORS headers manually:</p>

        <CodeBlock language="typescript">{`const server = createServer(async (req, res) => {
  // CORS headers
  res.setHeader("Access-Control-Allow-Origin", "http://localhost:5173");
  res.setHeader("Access-Control-Allow-Credentials", "true");
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");

  if (req.method === "OPTIONS") {
    res.writeHead(204);
    res.end();
    return;
  }

  const handled = await handler(req, res);
  // ...
});`}</CodeBlock>

        <h2>Next Steps</h2>

        <ul>
          <li><a href="/docs/guides/two-factor-authentication">Two-Factor Authentication</a></li>
          <li><a href="/docs/adapters">Database Adapters</a></li>
          <li><a href="/docs/mcp">MCP Integration</a></li>
          <li><a href="/docs/api-reference">API Reference</a></li>
        </ul>
      </div>
    </DocsLayout>
  );
}
